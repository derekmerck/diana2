DIANA Docker Swarm Stacks
=========================

Derek Merck  
<derek_merck@brown.edu>  
Rhode Island Hospital and Brown University  
Providence, RI  

[![Build Status](https://travis-ci.org/derekmerck/diana2.svg?branch=master)](https://travis-ci.org/derekmerck/diana2)
[![Coverage Status](https://codecov.io/gh/derekmerck/diana2/branch/master/graph/badge.svg)](https://codecov.io/gh/derekmerck/diana2)
[![Doc Status](https://readthedocs.org/projects/diana/badge/?version=master)](https://diana.readthedocs.io/en/master/?badge=master)

Source: <https://www.github.com/derekmerck/diana2>  
Documentation: <https://diana.readthedocs.io>  
Image:  <https://cloud.docker.com/repository/docker/derekmerck/diana2>


Admin Services
----------------------

A base stack and provides [Portainer][] and [Traefik][] services and networks.

[Traefik]: https://traefik.io
[Portainer]: https://portainer.io

### Setup

```bash
$ source sample.env
$ docker-stack -f admin/admin-stack.yml
```

### Exposes

- Traefik: `http://host:8080`
- Portainer: `http://host/portainer`


### Integration

Other stacks can attach to the Traefik network by declaring the network and adding appropriate service labels.

```yaml
networks:
  admin_proxy_network:
    external: true
```

Backend Data Services
----------------

Provides [Postgres][] database and [Redis][] and [Splunk][] indexing services and allocates persistent storage.

[Postgres]: https://www.postgresql.org
[Splunk]: https://www.splunk.com
[Redis]: https://www.redis.com

### Setup

```bash
$ source sample.env
$ docker-stack -f admin/admin-stack.yml
$ docker-stack -f bacekend-data/postgres-service.yml data
$ docker-stack -f bacekend-data/redis-service.yml data
$ docker-stack -f bacekend-data/splunk-service.yml data
```

### Exposes

- Postgres: `tcp://postgres:2345`
- Redis: `tcp://redis:6543`
- Splunk: `http://host/splunk`
- Splunk: `http://splunk:{8088,8089}`


DICOM Services
----------------

Provides [Orthanc][] DICOM nodes and ingress gateways.

### Setup

```bash
$ source sample.env
$ docker-stack -f dicom-node/archive-stack.yml
```

### Exposes

- Orthanc: `http://host/archive`
- Orthanc: `http://host/incoming`

[Orthanc]: https://www.orthanc-server.com


DIANA Worker Services
-----------------

### Mock PACS Stack

Provides an Orthanc DICOM node and fills it continuously with simulated DICOM headers generated by DIANA's MockSite daemon.

By default, the orthanc node is exposed at:

- Orthanc: `http://host/mock-pacs ` 
- Orthanc: `dcm:MOCKPACS@orthanc-mock:4242`  

### Setup

```bash
$ source sample.env
$ docker stack deploy -c admin/admin-stack.yml admin
$ docker-stack deploy -c diana-workers/mock-stack.yml mock
```

### Diana Watcher

Additionally, see [Remote Embedded Diana Watcher](https://github.com/derekmerck/red-dcm-watcher) for Raspberry Pi and Balena.

Provisioning
-------------------

### Setup a Swarm

```bash
$ docker swarm init --advertise-addr <ip_addr>
$ ssh host2
> docker swarm join ... etc
```

### Tag unique nodes for the scheduler

The `storage` node will be assigned the database backend.  
Any `bridge` nodes will be assigned DICOM ingress, routing, and bridging services (b/c typically modalities authorize endpoint access by specific IP address.)

```bash
$ docker node update --label-add storage=true host1   # mounts mass storage
$ docker node update --label-add bridge=true host2    # registered IP address for DICOM receipt
```

### Open the Firewall

If the firewall stops workers from joining see <https://www.digitalocean.com/community/tutorials/how-to-configure-the-linux-firewall-for-docker-swarm-on-centos-7>


### TODO

Grant orthanc user superuser privileges so it can create trigrams

License
-------------

MIT

